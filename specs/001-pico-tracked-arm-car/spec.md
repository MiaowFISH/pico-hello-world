# Feature Specification: Pico2W 履带机械臂小车控制系统

**Feature Branch**: `001-pico-tracked-arm-car`  
**Created**: 2026-01-01  
**Status**: Draft  
**Input**: 基于Raspberry Pi Pico2W的履带机械臂小车控制系统，前后端分离架构

## 概述

本系统是一个完整的履带式机械臂小车远程控制解决方案，用户可通过PC或手机浏览器实时控制小车的移动、底盘旋转和机械臂操作。系统采用配置驱动设计，所有硬件参数均可通过配置文件调整，无需修改代码。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 履带控制与移动 (Priority: P1)

用户打开浏览器访问小车控制界面，通过方向控制按钮或虚拟摇杆操控履带，实现小车前进、后退、左转、右转和原地旋转。

**Why this priority**: 移动是机器人最基础的功能，没有移动能力的小车无法执行任何有意义的任务。这是所有其他功能的前提。

**Independent Test**: 可通过浏览器访问控制界面，点击方向按钮验证小车是否按预期方向移动。仅实现此功能即可交付一个可遥控移动的履带小车。

**Acceptance Scenarios**:

1. **Given** 小车已开机且WiFi已连接, **When** 用户在浏览器访问控制界面并点击"前进"按钮, **Then** 两条履带同时正转，小车向前移动
2. **Given** 小车正在移动, **When** 用户松开方向按钮或点击"停止", **Then** 履带立即停止，小车停住
3. **Given** 小车静止, **When** 用户点击"左转"按钮, **Then** 左履带后转、右履带前转，小车原地左转
4. **Given** 小车静止, **When** 用户点击"右转"按钮, **Then** 左履带前转、右履带后转，小车原地右转
5. **Given** 小车正在移动, **When** WiFi连接中断超过2秒, **Then** 小车自动停止移动（安全保护）

---

### User Story 2 - 机械臂控制 (Priority: P2)

用户通过控制界面调节机械臂的3个关节（关节1、关节2、夹爪），实现机械臂的伸展、收缩和夹取物体功能。

**Why this priority**: 机械臂是本项目的核心差异化功能，使小车具备抓取和操作物体的能力，但需要先能移动到目标位置。

**Independent Test**: 可通过界面上的滑块或按钮控制各关节角度，观察机械臂是否按预期运动。仅实现此功能即可交付一个固定位置的可控机械臂。

**Acceptance Scenarios**:

1. **Given** 系统已启动, **When** 用户拖动"关节1"滑块到某角度值, **Then** 机械臂关节1平滑转动到该角度
2. **Given** 机械臂处于任意位置, **When** 用户点击"复位"按钮, **Then** 所有关节回到初始角度位置
3. **Given** 夹爪张开, **When** 用户点击"夹取"或拖动夹爪滑块到闭合位置, **Then** 夹爪闭合
4. **Given** 用户设置角度超出配置的安全范围, **When** 提交控制命令, **Then** 系统自动限制到安全范围内并提示用户
5. **Given** 机械臂正在运动, **When** WiFi连接中断, **Then** 机械臂保持当前位置不变

---

### User Story 3 - 底盘旋转控制 (Priority: P3)

用户通过控制界面操作底盘旋转电机，实现小车上部结构相对履带底盘的水平旋转，扩大机械臂的工作范围。

**Why this priority**: 底盘旋转是增强功能，可扩大机械臂工作范围，但即使没有此功能，小车仍可通过整体转向来调整方向。

**Independent Test**: 可通过界面上的旋转按钮控制底盘旋转，观察上部结构是否相对底盘转动。

**Acceptance Scenarios**:

1. **Given** 底盘静止, **When** 用户点击"顺时针旋转"按钮, **Then** 底盘顺时针旋转
2. **Given** 底盘静止, **When** 用户点击"逆时针旋转"按钮, **Then** 底盘逆时针旋转
3. **Given** 底盘正在旋转, **When** 用户松开按钮或点击"停止", **Then** 底盘停止旋转
4. **Given** 底盘旋转功能未使用超过设定时间, **When** 空闲超时, **Then** 驱动器自动进入休眠节能模式

---

### User Story 4 - 系统状态监控 (Priority: P4)

用户在控制界面实时查看系统状态，包括WiFi连接状态、各组件工作状态、当前配置参数等。

**Why this priority**: 状态监控有助于故障排查和用户体验，但不是核心控制功能。

**Independent Test**: 访问控制界面即可看到状态面板，显示当前连接状态和组件状态。

**Acceptance Scenarios**:

1. **Given** 用户访问控制界面, **When** 页面加载完成, **Then** 显示WiFi连接状态、信号强度和设备IP地址
2. **Given** 系统运行中, **When** 用户查看状态面板, **Then** 显示机械臂各关节当前角度
3. **Given** 某组件发生错误, **When** 系统检测到错误, **Then** 界面显示错误提示和可能的解决方案

---

### User Story 5 - 配置管理 (Priority: P5)

管理员可通过配置文件修改系统参数（WiFi、舵机限位、电机引脚等），系统启动时自动加载配置，无需修改代码。

**Why this priority**: 配置化设计便于维护和适配不同硬件，但只有在基本功能完成后才需要灵活配置。

**Independent Test**: 修改配置文件中的WiFi名称，重启后系统连接到新WiFi网络。

**Acceptance Scenarios**:

1. **Given** 配置文件存在且格式正确, **When** 系统启动, **Then** 读取并应用所有配置参数
2. **Given** 配置文件不存在, **When** 系统启动, **Then** 使用内置默认配置并记录警告日志
3. **Given** 配置文件中舵机角度范围已设置, **When** 控制舵机, **Then** 角度自动限制在配置范围内

---

### Edge Cases

- **网络异常**: 当WiFi连接断开或无控制命令超过2秒时，小车立即停止所有运动，机械臂保持当前位置
- **配置错误**: 当配置文件JSON格式错误时，系统使用默认配置启动并在日志中报错
- **参数越界**: 当用户请求的角度/速度超出配置的安全范围时，自动限制到边界值
- **并发控制**: 当多个客户端同时发送控制命令时，以最后收到的命令为准
- **电机堵转**: 用户需在物理层面注意避免电机堵转，系统不做堵转检测（无传感器）

## Requirements *(mandatory)*

### Functional Requirements

**后端 (CircuitPython on Pico2W)**

- **FR-001**: 系统MUST在启动时从配置文件加载所有硬件参数（引脚定义、舵机限位、WiFi凭证等）
- **FR-002**: 系统MUST连接到配置的WiFi网络并启动HTTP服务器，同时托管前端静态文件和API接口
- **FR-003**: 系统MUST通过I2C与PCA9685通信，控制3个机械臂舵机
- **FR-004**: 系统MUST通过GPIO PWM控制TB6612驱动板，实现履带差动转向
- **FR-005**: 系统MUST通过GPIO控制DRV8837驱动板，实现底盘旋转
- **FR-006**: 系统MUST提供WebSocket接口用于实时控制命令（履带、舵机、底盘旋转），延迟目标<50ms
- **FR-025**: 系统MUST提供HTTP API接口用于配置查询和状态获取（非实时操作）
- **FR-024**: 系统MUST实现2秒安全超时机制，无控制命令超过2秒时自动停止履带和底盘旋转电机
- **FR-007**: 系统MUST将舵机角度限制在配置的安全范围内（min_angle到max_angle）
- **FR-008**: 系统MUST在空闲时将DRV8837置于休眠模式以节能
- **FR-009**: 系统MUST提供状态查询接口，返回当前各组件状态
- **FR-022**: 系统MUST通过USB串口输出运行日志，用于开发调试（启动状态、错误信息、关键操作）

**前端 (React + Vite + TypeScript)**

- **FR-010**: 前端MUST提供响应式控制界面，适配PC和移动设备
- **FR-011**: 前端MUST提供履带方向控制（前进、后退、左转、右转、停止），采用Press-and-Hold模式（按住运动，松开即停）
- **FR-023**: 前端MUST提供履带速度档位选择（慢速/中速/快速），默认中速
- **FR-012**: 前端MUST提供机械臂各关节的角度控制滑块，显示当前角度
- **FR-013**: 前端MUST提供底盘旋转控制（顺时针、逆时针、停止），采用Press-and-Hold模式
- **FR-014**: 前端MUST提供机械臂复位按钮，一键恢复初始位置
- **FR-015**: 前端MUST显示系统连接状态和错误提示
- **FR-016**: 前端MUST在发送控制命令时提供即时视觉反馈

**API设计**

- **FR-017**: API MUST支持履带控制端点：设置左右履带速度和方向
- **FR-018**: API MUST支持舵机控制端点：设置指定通道舵机角度
- **FR-019**: API MUST支持底盘旋转端点：设置旋转方向和启停
- **FR-020**: API MUST支持状态查询端点：返回所有组件当前状态
- **FR-021**: API MUST支持配置查询端点：返回舵机限位等配置信息供前端使用

### Key Entities

- **舵机 (Servo)**: 代表机械臂的一个关节，包含通道号、名称、角度范围、脉宽范围、当前角度
- **履带电机组 (Track Motors)**: 代表左右两个履带电机，包含速度(-100~100)、运动状态
- **底盘旋转电机 (Base Motor)**: 代表底盘旋转机构，包含旋转方向、运行状态、休眠状态
- **系统配置 (Config)**: 代表所有硬件配置参数，包含WiFi、引脚映射、舵机参数等
- **设备状态 (Status)**: 代表系统当前状态，包含WiFi状态、各组件状态、错误信息

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户从打开控制界面到成功控制小车移动的时间不超过5秒
- **SC-002**: 控制命令从点击到小车响应的延迟不超过50毫秒（局域网环境，WebSocket连接）
- **SC-003**: 系统连续运行4小时以上不出现无响应或需要重启的情况
- **SC-004**: 前端界面在320px宽度的手机屏幕上仍可正常操作所有控制功能
- **SC-005**: 舵机角度控制精度达到±2度
- **SC-006**: 配置文件修改后，系统重启即生效，无需修改任何代码
- **SC-007**: 用户首次使用时，90%以上能在1分钟内理解界面并成功控制小车移动

## Clarifications

### Session 2026-01-01

- Q: 履带和底盘旋转的控制交互模式？ → A: 按住按钮持续运动，松开即停（Press-and-Hold模式）
- Q: 系统日志和调试信息的输出方式？ → A: 通过USB串口输出到PC终端（开发调试用）
- Q: 履带电机的速度控制方式？ → A: 提供2-3档预设速度（慢速/中速/快速）
- Q: 前端部署和访问方式？ → A: 前端构建后由Pico2W的HTTP服务器托管（访问Pico IP即可）
- Q: 连接断开时的安全超时时间？ → A: 2秒超时（平衡安全与网络抖动容忍）
- Q: 控制命令的通信协议？ → A: WebSocket用于实时控制（低延迟），HTTP用于配置/状态查询

## Assumptions

- WiFi网络稳定，Pico2W与控制设备在同一局域网内
- 硬件已按接线表正确连接，电源供电充足
- 用户使用现代浏览器（Chrome、Firefox、Safari、Edge近2年版本）
- 舵机和电机的机械负载在正常范围内，不会出现堵转
- 系统为单用户使用场景，不考虑多用户同时控制的冲突处理

## Out of Scope

- 摄像头视频流传输
- 自主导航和避障
- 传感器数据采集（如距离、温度）
- 用户认证和权限管理
- 数据持久化和操作历史记录
- OTA固件更新
